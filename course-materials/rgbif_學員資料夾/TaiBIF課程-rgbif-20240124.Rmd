---
title: "TaiBIFèª²ç¨‹-rgbif-20240124"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: console
---

# ç”Ÿç‰©å¤šæ¨£æ€§è³‡æ–™æ‡‰ç”¨èª²ç¨‹ - ä½¿ç”¨ `rgbif` å¥—ä»¶

##### tags: `è³‡æ–™æ‡‰ç”¨` `è³‡æ–™æ¸…ç†` `API` `GBIF` `TaiBIF`

</br >

### ğŸ“’ æ­¤æ•™æä¾†è‡ª 2024/01 æ‰€èˆ‰è¾¦çš„ã€Œ[TaiBIF](https://portal.taibif.tw/) ç”Ÿç‰©å¤šæ¨£æ€§è³‡æ–™æ‡‰ç”¨å·¥ä½œåŠã€
#### **Created by:** ä½•èŠ·è”š [Daphne Hoh](https://orcid.org/0000-0002-7810-1034), å³ä¿Šæ¯… Junyi Wu
#### **Created:** 2023-09-02
#### **Last modified:** 2024-01-17

</br >

## ğŸš© èª²ç¨‹ç›®æ¨™
#### 1. å­¸æœƒæ€éº¼ç”¨ R å¥—ä»¶ [*`rgbif`*](https://docs.ropensci.org/rgbif/) ä¸‹è¼‰ GBIF è³‡æ–™
#### 2. äº†è§£ GBIF æ‰€ä¸‹è¼‰çš„è³‡æ–™å¯èƒ½æœƒå‡ºç¾çš„å“è³ªå•é¡Œ (potential data quality issue)
#### 3. å¦‚ä½•æ¸…ç†æœ‰å“è³ªç–‘æ…®çš„è³‡æ–™
#### 4. ç•«å‡ºç‰©ç¨®å‡ºç¾ç´€éŒ„åˆ†å¸ƒåœ–
#### 5. å¦‚ä½•å¼•ç”¨æ‰€ä¸‹è¼‰çš„è³‡æ–™

</br >

## ğŸª„ èª²å‰æº–å‚™
#### 1. æ­¤èª²ç¨‹æ•™æå€‘[é€£çµ](https://drive.google.com/drive/folders/1se5qho_lbFC6HnecmWc0lVenv922NCjf?usp=drive_link)
#### 2. é€™æ¬¡èª²å ‚è£¡æ‰€ä½¿ç”¨çš„å·¥å…·ç‰ˆæœ¬ï¼š
  + R ç‰ˆæœ¬ï¼š4.3.2
  + *`rgbif`* ç‰ˆæœ¬ï¼š3.7.9
    
</br >

## (1) ğŸ’» ç’°å¢ƒæº–å‚™
```{r, message = F}
# é›™å¼•è™Ÿä¹‹é–“çš„æ–‡å­—è¦æ”¹ç‚ºè‡ªå·±çš„æ¡Œé¢è·¯å¾‘
setwd("/Users/taibif/Desktop/") # Mac
setwd("C:/Users/taibif/Desktop/") # Window

.packs <- c("rgbif", "rnaturalearth", "devtools", "tidyverse", "CoordinateCleaner", 
            "sf", "data.table", "ggplot2", "ggmap")
```


```{r, message = F}
install.packages(.packs)
sapply(.packs, require, character.only = T)

# ä¸‹åˆ—å¥—ä»¶éœ€è¦ä½¿ç”¨ devtools ä¾†è£ 
devtools::install_github("ropensci/rnaturalearthhires")
library(rnaturalearthhires)

# è·‘å‡ºæ­¤ Rmd æ•™æçš„é›»è…¦èˆ‡ R ç’°å¢ƒè¨­å®š
sessionInfo()
```

</br >

## (2) ğŸ” ä½¿ç”¨ rgbif å¥—ä»¶ä¾†ä¸‹è¼‰ GBIF çš„è³‡æ–™
### 2.1 - æ‰¾å‡ºç‰©ç¨®çš„ taxonKey
#### é€™æ¬¡çš„èª²å ‚ç¯„ä¾‹ï¼Œæˆ‘å€‘ä¾†çœ‹è‡ºç£çš„åŸç”Ÿç‰©ç¨®â€”è‡ºç£æ‰ *Taiwania cryptomerioides*
```{r}
# æ–¹æ³•ï¼ˆä¸€ï¼‰ï¼šåˆ° GBIF ç¶²ç«™æ‰¾ https://www.gbif.org/species/"XXXXXXX"
taxonKey <- 5284272

# æ–¹æ³•ï¼ˆäºŒï¼‰ï¼š
name_backbone(name = "Taiwania cryptomerioides", rank = "species") %>% 
  data.frame()
```
#### + æ³¨æ„ `status` æ¬„ä½æª¢æŸ¥è¼¸å…¥çš„å­¸åæ˜¯å¦æœ‰æ•ˆ
#### + æ³¨æ„ `matchType` æ¬„ä½æª¢æŸ¥è¼¸å…¥çš„å­¸åæ˜¯å¦ç‚ºä½ è¦æ‰¾çš„ç‰©ç¨®æˆ–æ˜¯å¦æ‹¼éŒ¯
#### + ç¯„ä¾‹åƒè€ƒï¼š
####    + name_backbone(name = "Magnoliophyta") # `status` æ˜¯ 'Synonym' (åŒç‰©ç•°å)
####    + name_backbone(name = "Aegithalos caudatus") # `status` æ˜¯ 'Doubtful' (æœ‰ç–‘æ…®çš„)
```{r}
# ä¸Šé¢æª¢æŸ¥æ²’å•é¡Œå¾Œï¼Œå­˜å…¥ taxonKey
taxonKey <- name_backbone(name = "Taiwania cryptomerioides", rank = "species") %>% 
  pull(usageKey)
```

</br >

### 2.2 - é‡å° taxonKey ä¸‹è¼‰å‡ºç¾ç´€éŒ„
```{r, message = F}
# è¦ç™»å…¥ GBIF å¸³è™Ÿæ‰èƒ½ä¸‹è¼‰è³‡æ–™
gbif_download_key <- occ_download(pred("taxonKey", taxonKey), # ä¸‹è¼‰æ­¤ taxonKey çš„å‡ºç¾ç´€éŒ„
                                  format = "SIMPLE_CSV",
                                  user = "yourGBIFuserID", # è¼¸å…¥ä½ çš„ GBIF User ID
                                  pwd = "yourPW", # å¯†ç¢¼
                                  email = "yourEmail@mail.com") # ç”¨ä¾†è¨»å†Š GBIF å¸³è™Ÿçš„ email

# æŸ¥çœ‹ä¸‹è¼‰ç‹€æ…‹
# å¦‚æœè³‡æ–™å¾ˆå¤šï¼Œæœƒéœ€è¦ç­‰ä¸€é™£å­
occ_download_wait(gbif_download_key)

# ç›´æ¥è®€é€² R æˆ data frame
# ä¹Ÿå¦å­˜ä¸€å€‹å£“ç¸®æª”åˆ°æœ¬æ©Ÿè·¯å¾‘
gbif_download <- occ_download_get(gbif_download_key, overwrite = T) %>% 
  occ_download_import()

head(gbif_download, 5) 
colnames(gbif_download) # çœ‹æœ‰ä»€éº¼æ¬„ä½
```
#### + çœ‹å„æ¬„ä½ä»£è¡¨ä»€éº¼ï¼šDarwin Core (DwC) Terms https://dwc.tdwg.org/list/
#### + å®Œæ•´çš„ DwC Terms æœ‰è¶…é 350 å€‹
#### + rgbif çš„ occ_download_get å…±æœ‰ 50 å€‹
#### + æœ‰ä¸€äº›æ¬„ä½ä¾‹å¦‚ï¼šgbifID, lastInterpreted, mediaType, issue ç­‰æ˜¯ GBIF è©®é‡‹è³‡æ–™ï¼Œä¸æ˜¯ DwC

</br >

## (3)ï¸ ğŸ§­ è³‡æ–™é»ä½è¦–è¦ºåŒ–
#### è‡ºç£æ‰ *Taiwania cryptomerioides* æ˜¯å°ç£ç‰¹æœ‰ç¨®ï¼Œæˆ‘å€‘å…ˆä¾†çœ‹ä¸€ä¸‹è³‡æ–™åœ¨åœ°åœ–ä¸Šçš„åˆ†å¸ƒ
```{r, message = F}
world.map <- ne_countries(returnclass = "sf") # ä¸‹è¼‰ä¸–ç•Œåœ°åœ–

# ä¸‹è¼‰çš„è³‡æ–™åœ¨ä¸–ç•Œçš„åˆ†å¸ƒ
ggplot() +
  geom_sf(data = world.map) +
  geom_point(data = gbif_download,
             aes(x = decimalLongitude, # ç¶“åº¦
                 y = decimalLatitude), # ç·¯åº¦
             shape = "+",
             color = "red") +
  theme_bw()
```
```{r, message = F}
tw.map <- ne_countries(country = "Taiwan", scale = "large", returnclass = "sf") # ä¸‹è¼‰è‡ºç£åœ°åœ–

# ä¸‹è¼‰çš„è³‡æ–™åœ¨è‡ºç£çš„åˆ†å¸ƒ
ggplot() +
  geom_point(data = gbif_download,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +
  geom_sf(data = tw.map)
  theme_bw()
  #ç¹ªè£½å‡ºä¾†çš„åœ°åœ–ï¼Œå¾ˆæ˜é¡¯çš„è³‡æ–™åˆ†å¸ƒæœ‰å¤§é‡éƒ½ä¸å†è‡ºç£æœ¬å³¶å…§
```

#### è‡ºç£æ‰æ˜¯å°ç£ç‰¹æœ‰ç¨®ï¼Œç‚ºä»€éº¼æœƒåœ¨åœ‹å¤–æœ‰é»ä½è³‡æ–™å‘¢ï¼Ÿ
#### 1. åœ¨åœ‹å¤–æ˜¯å…¸è—æ¨™æœ¬
#### 2. è®Šæˆåœ‹å¤–çš„å¤–ä¾†ç¨®ï¼Ÿï¼
#### ä¸ç®¡ä»€éº¼åŸå› ï¼Œé€™äº›ä¸æ˜¯æˆ‘å€‘æƒ³çœ‹çš„è³‡æ–™ï¼Œæ‰€ä»¥é‡å°é€™äº›è³‡æ–™åšæ¸…ç†

</br >

## (4) ğŸš§ è³‡æ–™æ¸…ç†
#### âš ï¸ æ³¨æ„ âš ï¸ æ¸…ç†è³‡æ–™çš„æ­¥é©Ÿæ²’æœ‰çµ±ä¸€çš„ä½œæ³•
#### æ‰€æœ‰æ¸…ç†æ­¥é©Ÿéƒ½æœƒä»¥ä½ çš„ç ”ç©¶ç›®çš„èˆ‡è¦åšçš„åˆ†ææ–¹å¼åšèª¿æ•´
#### æ­¤æ•™æè£¡æåˆ°çš„æ¸…ç†æ­¥é©Ÿæ˜¯ GBIF å»ºè­°å¯ä»¥æ³¨æ„çš„åœ°æ–¹

</br >

### 4.1 - æˆ‘åªæƒ³è¦åŸç”Ÿ & é‡ç”Ÿçš„å‡ºç¾ç´€éŒ„ï¼Œå»é™¤å…¸è—è³‡æ–™ï¼
```{r, message = F}
table(gbif_download$basisOfRecord) # basisOfRecord = è³‡æ–™é¡å‹
table(gbif_download$establishmentMeans) # establishmentMeans = åŸç”Ÿç‹€æ…‹ã€‚è‡ºç£æ‰é€™ä¾‹å­å‰›å¥½ä¸éœ€è¦æ¸…é€™å€‹ï¼Œä½†åˆ¥çš„è³‡æ–™å¯èƒ½éœ€è¦ã€‚

clean.step.1 <- gbif_download %>%
  filter(!basisOfRecord %in% c("FOSSIL_SPECIMEN", "LIVING_SPECIMEN", "PRESERVED_SPECIMEN")) %>% 
  filter(!establishmentMeans %in% c("MANAGED", "INTRODUCED", "INVASIVE", "NATURALISED"))


print(paste0(nrow(gbif_download) - nrow(clean.step.1), " records deleted; ",
             nrow(clean.step.1), " records remaining."))


# ä¾†çœ‹ä¸€ä¸‹è³‡æ–™æ¸…é™¤å‰èˆ‡å¾Œçš„åœ°ç†åˆ†å¸ƒ
ggplot() +
  geom_sf(data = world.map) +
  geom_point(data = gbif_download,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "blue") +  # è¢«ç§»é™¤çš„è³‡æ–™
  geom_point(data = clean.step.1,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +  # ä¿ç•™ä¸‹ä¾†çš„è³‡æ–™
  theme_bw()
```

</br >

### 4.2 - æŠŠä¸€äº›æœ‰æ˜é¡¯åœ°ç†éŒ¯èª¤çš„è³‡æ–™å»é™¤
#### ä½¿ç”¨æ–¹ä¾¿çš„ *`CoordinateCleaner`* å¥—ä»¶
```{r}
# ä»¥ä¸‹è¨»è§£åˆ†åˆ¥ç‚ºæ¸…ç†çš„éƒ¨åˆ†
clean.step.2 <- clean.step.1 %>% 
  filter(!is.na(decimalLatitude), !is.na(decimalLongitude), # ç„¡ç¶“ç·¯åº¦è³‡è¨Š
         countryCode == "TW") %>% # ä¿ç•™åœ¨å°ç£çš„é»ä½
  cc_dupl() %>% # ç¶“ç·¯åº¦é»ä½é‡è¤‡
  cc_zero() %>% # ç¶“ç·¯åº¦ç‚º 0
  cc_equ() %>% # ç¶“ç·¯åº¦ç‚ºåŒæ•¸å€¼
  cc_val() %>% # ç¶“ç·¯åº¦ç„¡æ•ˆ (ç·¯åº¦ > 90 & < -90; ç¶“åº¦ > 180 & < -180)
  cc_sea() %>% # æµ·ä¸Š
  cc_cen(buffer = 5) # åœ‹å®¶çš„ä¸­é–“é»ï¼Œæ•¸å­—å–®ä½æ˜¯å…¬é‡Œ

print(paste0(nrow(clean.step.1) - nrow(clean.step.2), " records deleted; ",
             nrow(clean.step.2), " records remaining."))  
```
```{r, message = F}
# ä¾†çœ‹ä¸€ä¸‹è³‡æ–™æ¸…é™¤å‰èˆ‡å¾Œçš„åœ°ç†åˆ†å¸ƒ
ggplot() +
  geom_sf(data = world.map) +
  geom_point(data = clean.step.1,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "blue") +  # è¢«ç§»é™¤çš„è³‡æ–™
  geom_point(data = clean.step.2,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +  # ä¿ç•™ä¸‹ä¾†çš„è³‡æ–™
  theme_bw()
```

#### ç§»é™¤æˆåŠŸï¼æˆ‘å€‘æ¥ä¸‹ä¾†çœ‹å°ç£çš„è³‡æ–™å°±å¥½
```{r, message = F}
ggplot() +
  geom_sf(data = tw.map) +
  geom_point(data = clean.step.2,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +
  theme_bw()
```

</br >

### 4.3 - ç§»é™¤åº§æ¨™ä¸ç¢ºå®šæ€§å¾ˆé«˜çš„è³‡æ–™
#### å¦‚æœç‰©ç¨®çš„å¯¦éš›é»ä½å°æ¥ä¸‹ä¾†è¦åšçš„åˆ†æå¾ˆé‡è¦
#### æ¯”å¦‚èªªï¼šç”¨ä¾†è·‘ç‰©ç¨®åˆ†å¸ƒæ¨¡å‹
#### é‚£å¿…é ˆé‡å° coordinateUncertaintyInMeters (åº§æ¨™ä¸ç¢ºå®šæ€§) æ¬„ä½åšé©ç•¶çš„æ¸…ç†
```{r}
table(gbif_download$coordinateUncertaintyInMeters)

clean.step.3 <- clean.step.2 %>% 
  filter(!is.na(coordinateUncertaintyInMeters) |  # ç§»é™¤ç©ºå€¼
           coordinateUncertaintyInMeters < 1000)  # ä¿ç•™ < 1000 å…¬å°ºä»¥ä¸‹çš„

print(paste0(nrow(clean.step.2) - nrow(clean.step.3), " records deleted; ",
             nrow(clean.step.3), " records remaining." ))  
```

</br >

### 4.4 - æˆ‘å°å¾ˆèˆŠæˆ–ç„¡å¹´ä»½çš„ç´€éŒ„æœ‰ç–‘æ…®ï¼Œç§»é™¤ï¼
#### åœ¨ GBIF è£¡ï¼Œå¾ˆèˆŠçš„ç´€éŒ„é€šå¸¸æ˜¯æ¨™æœ¬
```{r}
# è¦–æƒ…æ³è‡ªå·±å®šç¾©è©²ä¿ç•™ä»€éº¼å¹´ä»½
table(clean.step.3$year)

clean.step.4 <- clean.step.3 %>% 
  filter(year > 1980 & year < 2025) # æœ‰äº›è³‡æ–™ä¹Ÿæœƒå‡ºç¾â€œæœªä¾†â€å¹´ä»½ï¼Œç§»é™¤
```

</br >

### 4.5 - æœ€å¾Œæª¢è¦–åˆ°åº•è¢«ç§»é™¤å¤šå°‘æœ‰ç–‘æ…®çš„è³‡æ–™
```{r, message = F}
ggplot() +
  geom_sf(data = tw.map) +
  geom_point(data = gbif_download,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "blue") +  # æ‰€æœ‰è¢«ç§»é™¤çš„è³‡æ–™
  geom_point(data = clean.step.4,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +  # æ¸…ç†å¾Œï¼Œä¿ç•™ä¸‹ä¾†çš„è³‡æ–™
  theme_bw() +
  coord_sf(xlim = st_bbox(tw.map)[c(1,3)],
           ylim = st_bbox(tw.map)[c(2,4)])
```

### 4.6 - æ¸…ç†å¾Œï¼Œå‰©ä¸‹çš„è³‡æ–™
```{r}
ggplot() +
  geom_sf(data = tw.map) +
  geom_point(data = clean.step.4,
             aes(x = decimalLongitude,
                 y = decimalLatitude),
             shape = "+",
             color = "red") +
  theme_bw()
```

#### æ¸…ç†å¾Œèƒ½ç”¨çš„è³‡æ–™å¾å‰›é–‹å§‹çš„ 1,123 ç­†åˆ°åªå‰© 89 ç­† 
#### ç•¶ç„¶ä¹Ÿå¯èƒ½æ˜¯å› ç‚ºå°è³‡æ–™å“è³ªçš„è¦æ±‚å¤ªåš´æ ¼äº†
#### å†è¦–æƒ…æ³è‡ªå·±èª¿æ•´å•¦ï½ 

</br >

## (5) ğŸ—º ä¾†å€‹åœ–å±¤ + ç¶²æ ¼æ•™å­¸
### ä¸‹è¼‰ GBIF ç‰¹å®šç¯„åœçš„ç‰©ç¨®å‡ºç¾ç´€éŒ„
```{r}
location <- "POLYGON((121.61304 25.04929, 121.61085 25.0495, 121.60583 25.04833, 121.60672 25.04555, 121.60627 25.04138, 121.60915 25.03876, 121.61668 25.03708, 121.61675 25.03795, 121.61759 25.03972, 121.61724 25.04091, 121.61682 25.04208, 121.61624 25.04317, 121.61507 25.04574, 121.61554 25.0474, 121.61563 25.0488, 121.61304 25.04929))"


# å¦ä¸€ç¨®æ›´å¿«é€Ÿç¯©é¸ã€é¸æ“‡ç‰¹å®šç¯„åœèˆ‡ä¸‹è¼‰ GBIF è³‡æ–™çš„æ–¹æ³•
gbif_download_key <- occ_download(pred_within(location),
                                  pred_or(pred_lt("coordinateUncertaintyInMeters", 1000),
                                          pred_notnull("coordinateUncertaintyInMeters")),
                                  format = "SIMPLE_CSV",
                                  user = "yourGBIFuserID", # è¼¸å…¥ä½ çš„ GBIF User ID
                                  pwd = "yourPW", # å¯†ç¢¼
                                  email = "yourEmail@mail.com") # ç”¨ä¾†è¨»å†Š GBIF å¸³è™Ÿçš„ email

# ä¸‹è¼‰ä¸¦è§£å£“ç¸®
gbif_download_metadata <- occ_download_wait(gbif_download_key)
gbif_download_path <- "./gbif_download.zip" # æŒ‡å®šä¸‹è¼‰æª”æ¡ˆçš„è·¯å¾‘
download.file(gbif_download_metadata$downloadLink, gbif_download_path) # ä¸‹è¼‰åˆ°æœ¬æ©Ÿ
unzip(gbif_download_path) # åœ¨æœ¬æ©Ÿå£“ç¸®ä¸‹è¼‰æª”

GBIF_data <- fread(sprintf("%s.csv", gbif_download_metadata$key), 
                   sep = "\t", fill = T, encoding = "UTF-8", colClasses = "character", quote = "")


# å°‡ WKT è½‰æ›ç‚º sf object
sfc <- st_as_sfc(location)
polygon_sf <- st_sf(geometry = sfc)

# åŠƒå¤šé‚Šå½¢
gg <- ggplot(data = polygon_sf) +
  geom_sf(data = polygon_sf,
          color = "black", size = 0.2, inherit.aes = F, alpha = 0.3)
print(gg)

# è¨­å®šåŸå§‹åæ¨™ç³»çµ± (å…ˆå‘Šè¨´ R é è¨­åœ–å±¤æ˜¯æ˜¯ WGS84, EPSG:4326)
st_crs(polygon_sf) <- 4326

# è½‰æ›åˆ° TWD97 (EPSG:3826)ã€‚ç¹ªè£½ç¶²æ ¼å¿…é ˆè¦è®“åæ¨™ç³»çµ±è½‰æ›æˆäºŒåº¦åˆ†å¸¶æ‰ç²¾æº–
polygon_sf_twd97 <- st_transform(polygon_sf, 3826)


# å‰µå»º 100m x 100m çš„ç¶²æ ¼
grid <- st_make_grid(polygon_sf_twd97, cellsize = c(100, 100)) %>% 
  st_as_sf()

# ç•«å‡º grid
gg_grid <- ggplot(data = grid) +
  geom_sf(data = grid,
          color = "black", size = 0.2, inherit.aes = F, alpha = 0.3)
print(gg_grid)

# ç”¨ç”¢ç”Ÿçš„ Polygon æŒ‘é¸ç¶²æ ¼
intersects_result <- st_intersects(grid, polygon_sf_twd97)
selected_grids <- grid[unlist(lapply(intersects_result, length)) > 0, ]

# ç•«å‡ºç¯©é¸ grid èˆ‡å¤šé‚Šå½¢é‡ç–Šåœ–
gg_grid <- ggplot() +
  geom_sf(data = selected_grids, fill = "red", alpha = 0.5) + # ç¹ªè£½ selected_grids
  geom_sf(data = polygon_sf_twd97, fill = "lightblue") + # ç¹ªè£½ polygon_sf_twd97
  theme_minimal()
print(gg_grid)

# å°‡ GBIF_data æ ¹æ“šåº§æ¨™è½‰æˆ Point polygonï¼Œå› åº§æ¨™æœ¬èº«æ˜¯WGS84ï¼Œæ•…æŠ•å½±æˆWGS84
GBIF_sf <- st_as_sf(GBIF_data, coords = c("decimalLongitude", "decimalLatitude"), crs = 4326)

# ç•«å‡º GBIF é»ä½åœ–
gg_point <- ggplot() +
  geom_sf(data = GBIF_sf)
print(gg_point)

# ç•«å‡º GBIF é»ä½ä»¥åŠç¯©é¸ grid é‡ç–Šåœ–
gg_grid_point <- ggplot() +
  geom_sf(data = selected_grids, fill = "red", alpha = 0.5) + # ç¹ªè£½ selected_grids
  geom_sf(data = GBIF_sf)+
  theme_minimal()
print(gg_grid_point)


# å› ç‚º GBIF çš„è³‡æ–™çš„åº§æ¨™ç³»çµ±éƒ½æ˜¯ WGS84ï¼Œå°‡é»ä½åœ–å±¤è½‰æˆ TWD97
GBIF_sf_TWD97 <- st_transform(GBIF_sf, crs = 3826)

# ç”¢ç”Ÿé‚è¼¯çŸ©é™£ï¼Œåˆ¤æ–·å…©å€‹åœ–å±¤æœ‰å¤šå°‘è³‡æ–™æœ‰äº¤é›†
points_per_grid <- st_intersects(GBIF_sf_TWD97, selected_grids, sparse = F)

# å°‡é‚è¼¯èˆ‰è­‰è½‰æ›æˆæ•¸åˆ—ï¼Œè¨ˆç®—æ¯å€‹ç¶²æ ¼æœ‰å¤šå°‘é»ä½æ•¸é‡
count_points <- apply(points_per_grid, 2, sum)
selected_grids$count <- count_points

# ç¹ªè£½ç†±é»åœ–
gg <- ggplot(data = selected_grids) +
  geom_sf(aes(fill = count), color = "black", size = 0.2) +
  scale_fill_gradientn(colors = c("white", "blue", "red"), 
                       values = scales::rescale(c(0, 1, max(selected_grids$count, na.rm = T))),
                       na.value = "white", 
                       name = "Count") +
  theme_minimal() +
  labs(title = "Selected Grids based on Count", x = "Longitude", y = "Latitude")
print(gg)


# å°‡å®Œæˆçš„ç¶²æ ¼è¼¸å‡ºæˆ shapefileï¼Œå¯ä»¥åœ¨ GIS è»Ÿé«”ä¸Šæ“ä½œç·¨è¼¯
# st_write(selected_grids, "output\\RGBIF_result.shp")
```

</br >

## (6) ğŸŒ å¼•ç”¨æ–¹æ³•
```{r}
gbif_download_key

print(gbif_citation(occ_download_meta(gbif_download_key))$download)
```

</br >

### ğŸ’ å…¶ä»–
#### å¦‚æœæƒ³è©¦åˆ¥çš„ç‰©ç¨®è³‡æ–™ï¼š
```{r}
#name_backbone(name = "Macaca cyclopis", rank = "species") # è‡ºç£ç¼çŒ´
#name_backbone(name = "Odorrana swinhoana", rank = "species") # æ–¯æ–‡è±ªæ°è›™
#name_backbone(name = "Yuhina brunneiceps", rank = "species") # å† ç¾½ç•«çœ‰
#name_backbone(name = "Alpinia uraiensis", rank = "species") # çƒä¾†æœˆæ¡ƒ
```

</br >

### ğŸ“š å»¶ä¼¸é–±è®€
1. GBIF interpreted data - [Issues and Flags](https://data-blog.gbif.org/post/issues-and-flags/) 
2. List of [Darwin Core Term](https://dwc.tdwg.org/list/)
3. Data blog - [GBIF API beginners guide](https://data-blog.gbif.org/post/gbif-api-beginners-guide/)
4. Data blog - [GBIF Species API](https://data-blog.gbif.org/post/gbif-species-api/)
5. GBIF å‡ºç‰ˆæ–‡ä»¶ - [è³‡æ–™å“è³ªåŸå‰‡](https://www.gbif.org/document/80509/principles-of-data-quality) ([è‹±](https://assets.ctfassets.net/uo17ejk9rkwj/2gupj7dJIw62UeOUYiqSsm/0a4bb732bd7fd8cf28f7703dc20a43ba/Data_Quality_-_ENGLISH.pdf)/[ä¸­è­¯](https://assets.ctfassets.net/uo17ejk9rkwj/3IabOUm6FWoikQKceYIQ8g/59fa78644598800faa096c157ce36b03/Principles_20of_20Data_20Quality_20-_20Chinese.pdf))
6. GBIF å‡ºç‰ˆæ–‡ä»¶ - [åŸå§‹ç‰©ç¨®èˆ‡ç‰©ç¨®å‡ºç¾ç´€éŒ„è³‡æ–™](https://www.gbif.org/document/80528/principles-and-methods-of-data-cleaning-primary-species-and-species-occurrence-data)

</br >

### ğŸ’¡ åƒè€ƒ
1. **Main reference for this course material / Modified from:** GBIF Secretariat (2021) GBIF Biodiversity Data Use Course. 6th edition. GBIF Secretariat: Copenhagen. https://doi.org/10.15468/ce-wkk4-2w26. 

2. Chamberlain S, Barve V, Mcglinn D, Oldoni D, Desmet P, Geffert L, Ram K (2023). rgbif: Interface to the Global Biodiversity Information Facility API. R package version 3.7.9, https://CRAN.R-project.org/package=rgbif.

</br >

***
> This document is part of a course materials developed for [TaiBIF](https://portal.taibif.tw/) Data Use Workshop (2024-01-24).

